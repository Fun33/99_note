(function(b,d){if(!b.Deferred){var a="done fail isResolved isRejected promise then always pipe".split(" "),e=[].slice;jQuery.extend({_Deferred:function(){var i=[],j,g,h,f={done:function(){if(!h){var l=arguments,m,p,o,n,k;if(j){k=j;j=0}for(m=0,p=l.length;m<p;m++){o=l[m];n=jQuery.type(o);if(n==="array"){f.done.apply(f,o)}else{if(n==="function"){i.push(o)}}}if(k){f.resolveWith(k[0],k[1])}}return this},resolveWith:function(l,k){if(!h&&!j&&!g){k=k||[];g=1;try{while(i[0]){i.shift().apply(l,k)}}finally{j=[l,k];g=0}}return this},resolve:function(){f.resolveWith(this,arguments);return this},isResolved:function(){return !!(g||j)},cancel:function(){h=1;i=[];return this}};return f},Deferred:function(g){var f=jQuery._Deferred(),i=jQuery._Deferred(),h;jQuery.extend(f,{then:function(k,j){f.done(k).fail(j);return this},always:function(){return f.done.apply(f,arguments).fail.apply(this,arguments)},fail:i.done,rejectWith:i.resolveWith,reject:i.resolve,isRejected:i.isResolved,pipe:function(k,j){return jQuery.Deferred(function(l){jQuery.each({done:[k,"resolve"],fail:[j,"reject"]},function(n,q){var m=q[0],p=q[1],o;if(jQuery.isFunction(m)){f[n](function(){o=m.apply(this,arguments);if(o&&jQuery.isFunction(o.promise)){o.promise().then(l.resolve,l.reject)}else{l[p+"With"](this===f?l:this,[o])}})}else{f[n](l[p])}})}).promise()},promise:function(k){if(k==null){if(h){return h}h=k={}}var j=a.length;while(j--){k[a[j]]=f[a[j]]}return k}});f.done(i.cancel).fail(f.cancel);delete f.cancel;if(g){g.call(f,f)}return f},when:function(m){var g=arguments,h=0,l=g.length,k=l,f=l<=1&&m&&jQuery.isFunction(m.promise)?m:jQuery.Deferred();function j(n){return function(i){g[n]=arguments.length>1?e.call(arguments,0):i;if(!(--k)){f.resolveWith(f,e.call(g,0))}}}if(l>1){for(;h<l;h++){if(g[h]&&jQuery.isFunction(g[h].promise)){g[h].promise().then(j(h),f.reject)}else{--k}}if(!k){f.resolveWith(f,g)}}else{if(f!==m){f.resolveWith(f,l?[m]:[])}}return f.promise()}})}function c(){this.debug=false;this.count=6;this.style="box";this.site="emma";this.headerText="您可能會有興趣的文章";this._triggerClass="pix-related-post-showed";this._bindEvent="show.relatedpost";this._divClass="pix-related-post";this._posts=[];this._sources={}}b.extend(c.prototype,{log:function(){if(this.debug&&console&&console.log){console.log.apply(console,arguments)}},init:function(){if(!this._initialize){var f=this;b(window).scroll(function(){f.scroll.apply(f)})}this._initialize=true;if(typeof arguments[0]=="object"){b.extend(this,arguments[0])}},hookDiv:function(g){var j=b('<div class="'+this._divClass+'"></div>');var h=typeof this.container;var f=g;if(h=="string"){f=b(this.container,g)}else{if(h=="function"){f=this.container.apply(g)}}var i=this;j.bind(this._bindEvent,function(){var l=[];for(name in i._sources){var k=i.onVisible.apply(g,[name]);if(k){l.push(i._sources[name].fetch.apply(k))}}b.when.apply(b,l).then(function(){var m,n,o=[];for(m=0,n=arguments.length;m<n;m++){o=o.concat(arguments[m])}o.sort(function(q,p){return p.score-q.score});i.log(o);i.showPost(g,o)})});b(f).append(j);return j},scroll:function(){var i=b(window).scrollTop();var h=b(window).height();var f=i+h;var g=this;b("."+this._divClass).each(function(){var l=b(this);var j=l.offset().top;var k=l.offset().top;if(f-j>0&&i-k){if(l.hasClass(g._triggerClass)){return}l.addClass(g._triggerClass);l.trigger(g._bindEvent);l.unbind(g._bindEvent)}})},addSource:function(f,g){if(g.init){g.init()}this._sources[f]=g;return this},_addPost:function(f){this.hookDiv(f);this._posts.push(f);return this},addPosts:function(f){if(b.type(f)=="array"){var g=this;b.each(f,function(){g._addPost(this)})}else{this._addPost(f)}return this},showPost:function(o,h){if(b.type(h)!="array"||h.length==0){return}if(this.onShow){var m=this.onShow(o,h)}var g=(m&&m.style)||this.style||"box",k=(m&&m.count)||this.count,p=(m&&m.posts)||h,j=(m&&m.headerText)||this.headerText;if(b.type(p)!="array"||p.length==0){return}var i=new Image();i.onload=i.onerror=i.onabort=function(){return false};i.src="//pixanalytics.com/relate.gif?ver=1.1&random="+Math.random()+"&type=show&src="+encodeURIComponent(location.href)+"&style="+g+"&count="+k;var f=b('<div class="recommended-posts">');if(g=="box"){f.addClass("recommended-posts3")}else{if(g=="list"){f.addClass("recommended-posts1 nobg")}}f.append("<h5><span>"+j+"</span></h5>");if(g=="list"){f.append(b('<img class="recommended-post-image">').attr("src",p[0].thumb))}var l=b("<ul>");var n=this;b(p).each(function(r,s){if(r>k-1){return}var q=b("<a>");q.attr("href",s.link);q.click(function(w){try{var u=new Image();var x=b(this).attr("href");setTimeout(function(){location.href=x},1500);u.onload=u.onerror=u.onabort=function(){location.href=x};u.src="//pixanalytics.com/relate.gif?ver=1.1&random="+Math.random()+"&type=click&src="+encodeURIComponent(location.href)+"&dst="+encodeURIComponent(x)+"&style="+g+"&count="+k}catch(v){location.href=x}w.preventDefault()});if(n.debug){q.attr("title",s.score)}if(g=="list"){q.text(s.title);l.append(b("<li>").append(q).attr("meta",s.thumb))}else{var t=b('<div class="article-image-box">').append(b("<img>").attr("src",s.thumb).addClass("article-image"));if(s.source!="emma"&&s.source!=n.site){t.append(b('<span class="partner-logo">').append('<img src="'+s.banner+'">'))}q.append(t);q.append(b("<span>").addClass("article-text").text(s.title));l.append(b("<li>").append(q))}});f.append(l);b("."+this._divClass,o).append(f);if(g=="list"){b(".recommended-posts1 > ul > li",o).hover(function(){var q=b(this).parents(".recommended-posts1");b("ul > li a.selected",q).removeClass("selected");b("a",this).addClass("selected");var r=b(this).attr("meta");b("img",q).attr("src",r)})}}});b.relatedpost=new c();b.relatedpost.addSource("emma",{init:function(){b(function(){var f=document.createElement("link");f.rel="stylesheet";f.type="text/css";f.href="http://s.pixfs.net/blog/plugins/related/new.css?v=2011092301";document.getElementsByTagName("head")[0].appendChild(f)})},fetch:function(){var f=this.limit||b.relatedpost.count,g="http://emma.pixnet.cc/blog/articles/"+this.postId+"/related?user="+this.user+"&limit="+f+"&callback=?";return b.Deferred(function(){var h=this;b.getJSON(g,function(i){if(b.isArray(i.articles)){b.each(i.articles,function(){this.source="emma"});h.resolve(i.articles)}else{h.reject()}})}).promise()}}).addSource("techbang",{fetch:function(){var g=this.permallink.substr(7);var f="http://api.i.pixnet.cc/more/like/"+g+(g.indexOf("?")>0?"&":"?")+"callback=?";return b.Deferred(function(){var h=this;b.getJSON(f,function(i){if(b.isArray(i)){b.each(i,function(){this.source="techbang"});h.resolve(i)}else{h.reject()}})}).promise()}}).addSource("pixnet",{fetch:function(){var g=this.permallink.substr(7);var f="http://api.i.pixnet.cc/more/like/"+g+(g.indexOf("?")>0?"&":"?")+"callback=?&from=pixnet";return b.Deferred(function(){var h=this;b.getJSON(f,function(i){if(b.isArray(i)){b.each(i,function(){this.source="pixnet"});h.resolve(i)}else{h.reject()}})}).promise()}});b.fn.relatedpost=function(f){if(f in b.relatedpost){return b.relatedpost[f].apply(b.relatedpost,Array.prototype.slice.call(arguments,1))}else{if(typeof f==="object"||!f){b.relatedpost.init.apply(b.relatedpost,arguments);b.relatedpost.addPosts(this.get());return this}else{b.error("Method "+f+" does not exist on jQuery.relatedpost")}}}})(jQuery);